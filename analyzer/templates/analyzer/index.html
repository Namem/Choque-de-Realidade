{% extends "analyzer/base.html" %}

{% block content %}
<div class="container">
    <div class="text-center mb-4">
        <h1>Analisador de Circuitos CA Monofásico</h1>
        <p class="lead">Insira a descrição do circuito no formato netlist para iniciar a análise.</p>
    </div>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card h-100">
                <h5 class="card-header">Entrada do Circuito (Netlist)</h5>
                <div class="card-body">
                    <form id="circuit-form">
                        <div class="mb-3">
                            <label for="netlist-input" class="form-label">Cole ou digite sua netlist aqui:</label>
                            <textarea class="form-control" id="netlist-input" rows="12" spellcheck="false" style="font-family: monospace;">
* Exemplo de Circuito RLC Série
VS 1 0 120 0 60
R1 1 2 10
L1 2 3 0.05
C1 3 0 0.0001
                            </textarea>
                        </div>
                        <button type="button" id="analyze-button" class="btn btn-primary w-100">Analisar Circuito</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <h5 class="card-header">Resultados da Análise</h5>
                <div class="card-body">
                    <p>Os resultados da análise aparecerão aqui.</p>
                    <div id="results-output" style="font-family: monospace; white-space: pre-wrap; background-color: #212529; padding: 15px; border-radius: 5px;">Aguardando análise...</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% extends "analyzer/base.html" %}

{% block content %}
<div class="container">
    <div class="text-center mb-4">
        <h1>Analisador de Circuitos CA Monofásico</h1>
        <p class="lead">Insira a descrição do circuito no formato netlist para iniciar a análise.</p>
    </div>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card h-100">
                <h5 class="card-header">Entrada do Circuito (Netlist)</h5>
                <div class="card-body d-flex flex-column">
                    <form id="circuit-form" class="flex-grow-1 d-flex flex-column">
                        <div class="mb-3 flex-grow-1 d-flex flex-column">
                            <label for="netlist-input" class="form-label">Cole ou digite sua netlist aqui:</label>
                            <textarea class="form-control flex-grow-1" id="netlist-input" spellcheck="false" style="font-family: monospace;">
* Exemplo de Circuito RLC Série
VS 1 0 120 0 60
R1 1 2 10
L1 2 3 0.05
C1 3 0 0.0001
                            </textarea>
                        </div>
                        <button type="button" id="analyze-button" class="btn btn-primary w-100">Analisar Circuito</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <h5 class="card-header">Resultados da Análise</h5>
                <div class="card-body">
                    <div id="results-output" style="font-family: monospace; white-space: pre-wrap;">Aguardando análise...</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}


{% block javascript %}
<script>
    // Função auxiliar para obter o cookie CSRF (necessário para a segurança do Django)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Garante que o script rode apenas depois que a página carregar completamente
    document.addEventListener('DOMContentLoaded', () => {
        const analyzeButton = document.getElementById('analyze-button');
        const netlistInput = document.getElementById('netlist-input');
        const resultsOutput = document.getElementById('results-output');

        analyzeButton.addEventListener('click', () => {
            const netlistText = netlistInput.value;

            // Feedback visual para o usuário
            resultsOutput.style.color = 'inherit';
            resultsOutput.textContent = 'Analisando...';
            analyzeButton.disabled = true;

            // A chamada para a nossa API Django usando fetch
            fetch('/api/analyze/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ netlist: netlistText })
            })
            .then(response => response.json()) // Converte a resposta para JSON
            .then(data => {
                // Manipula a resposta da API
                if (data.success) {
                    let formattedResults = "Análise Concluída:\n\n";
                    const results = data.results;
                    for (const key in results) {
                        if (key.startsWith('V(')) {
                            const nodeVoltage = results[key];
                            formattedResults += `${key}: Magnitude = ${nodeVoltage.magnitude.toFixed(4)} V, Fase = ${nodeVoltage.phase_deg.toFixed(4)}°\n`;
                        }
                    }
                    resultsOutput.textContent = formattedResults;
                } else {
                    // Exibe a mensagem de erro da API
                    resultsOutput.style.color = 'red';
                    resultsOutput.textContent = `Erro: ${data.error}`;
                }
            })
            .catch(error => {
                // Lida com erros de rede ou outros problemas
                console.error('Erro na requisição:', error);
                resultsOutput.style.color = 'red';
                resultsOutput.textContent = 'Erro de comunicação com o servidor.';
            })
            .finally(() => {
                // Reabilita o botão, independentemente do resultado
                analyzeButton.disabled = false;
            });
        });
    });
</script>
{% endblock javascript %}