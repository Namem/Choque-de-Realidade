{% extends "analyzer/base.html" %}

{% block content %}
<div class="container">
    <div class="text-center mb-4">
        <h1>Analisador de Circuitos CA Monofásico</h1>
        <p class="lead">Insira a descrição do circuito no formato netlist para iniciar a análise.</p>
    </div>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card h-100">
                <h5 class="card-header">Entrada do Circuito (Netlist)</h5>
                <div class="card-body d-flex flex-column">
                    <form id="circuit-form" class="flex-grow-1 d-flex flex-column">
                        {% csrf_token %}
                        <div class="mb-3 flex-grow-1 d-flex flex-column">
                            <label for="netlist-input" class="form-label">Cole ou digite sua netlist aqui:</label>
                            <textarea class="form-control flex-grow-1" id="netlist-input" spellcheck="false" style="font-family: monospace;">
* Exemplo de Circuito RLC Série
VS 1 0 120 0 60
R1 1 2 10
L1 2 3 0.05
C1 3 0 0.0001
                            </textarea>
                        </div>
                        <button type="button" id="analyze-button" class="btn btn-primary w-100">Analisar Circuito</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <h5 class="card-header">Resultados da Análise</h5>
                <div class="card-body">
                    <div id="results-output" style="font-family: monospace; white-space: pre-wrap; margin-bottom: 1rem;">Aguardando análise...</div>
                    <canvas id="phasor-diagram-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}


{% block javascript %}
<script>
    function getCookie(name) { /* ...código do cookie... (sem alteração) */
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    document.addEventListener('DOMContentLoaded', () => {
        const analyzeButton = document.getElementById('analyze-button');
        const netlistInput = document.getElementById('netlist-input');
        const resultsOutput = document.getElementById('results-output');
        const canvasContext = document.getElementById('phasor-diagram-canvas').getContext('2d');
        let phasorChart = null; // Variável para guardar nosso gráfico

        analyzeButton.addEventListener('click', () => {
            const netlistText = netlistInput.value;
            resultsOutput.style.color = 'inherit';
            resultsOutput.textContent = 'Analisando...';
            analyzeButton.disabled = true;

            fetch('/api/analyze/', { /* ...código do fetch... (sem alteração) */
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify({ netlist: netlistText })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // --- 1. Atualiza os resultados de texto ---
                    let formattedResults = "Análise Concluída:\n\n";
                    const results = data.results;
                    for (const key in results) {
                        if (key.startsWith('V(')) {
                            const nodeVoltage = results[key];
                            formattedResults += `${key}: Magnitude = ${nodeVoltage.magnitude.toFixed(4)} V, Fase = ${nodeVoltage.phase_deg.toFixed(4)}°\n`;
                        }
                    }
                    resultsOutput.textContent = formattedResults;

                    // --- 2. Cria ou atualiza o diagrama fasorial ---
                    if (phasorChart) {
                        phasorChart.destroy(); // Destrói o gráfico antigo antes de criar um novo
                    }
                    createPhasorDiagram(results);

                } else {
                    resultsOutput.style.color = 'red';
                    resultsOutput.textContent = `Erro: ${data.error}`;
                    if (phasorChart) { phasorChart.destroy(); phasorChart = null; } // Limpa o gráfico em caso de erro
                }
            })
            .catch(error => { /* ...código do catch... (sem alteração) */
                console.error('Erro na requisição:', error);
                resultsOutput.style.color = 'red';
                resultsOutput.textContent = 'Erro de comunicação com o servidor.';
            })
            .finally(() => { analyzeButton.disabled = false; });
        });

        function createPhasorDiagram(results) {
            const datasets = [];
            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
            let colorIndex = 0;

            // Prepara os dados para o Chart.js
            for (const key in results) {
                if (key.startsWith('V(')) {
                    const voltage = results[key];
                    const magnitude = voltage.magnitude;
                    const phaseRad = voltage.phase_deg * (Math.PI / 180); // Converte fase para radianos
                    
                    // Converte de polar (mag, fase) para cartesiano (x, y)
                    const x = magnitude * Math.cos(phaseRad);
                    const y = magnitude * Math.sin(phaseRad);
                    
                    datasets.push({
                        label: key,
                        data: [{x: 0, y: 0}, {x: x, y: y}], // Um vetor da origem até o ponto (x,y)
                        borderColor: colors[colorIndex % colors.length],
                        backgroundColor: colors[colorIndex % colors.length],
                        showLine: true, // Conecta os pontos para formar o vetor
                        tension: 0 // Linhas retas
                    });
                    colorIndex++;
                }
            }

            // Cria o gráfico
            phasorChart = new Chart(canvasContext, {
                type: 'scatter',
                data: {
                    datasets: datasets
                },
                options: {
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'center',
                            grid: {
                                color: '#444' // Cor da grade para tema escuro
                            }
                        },
                        y: {
                            type: 'linear',
                            position: 'center',
                             grid: {
                                color: '#444'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Diagrama Fasorial'
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock javascript %}